@page "/"
@using MudBlazor
@using System.Threading
@using System.Net.Http.Json
@inject HttpClient Http

<MudPaper Class="pa-4" Elevation="2" Style="width: 400px; margin: auto;">

    <!-- Top Section -->
    <MudGrid>
        <MudItem xs="5">
            <MudAutocomplete T="string"
                             Label="Sura Nomi"
                             Value="_state"
                             ValueChanged="OnSurahSelected"
                             SearchFunc="@Search"
                             Variant="Variant.Filled"
                             ShowProgressIndicator="true"
                             MaxItems="114" />
        </MudItem>
        <MudItem xs="3">
            <MudNumericField T="int" Label="Ayah" Dense="true" @bind-Value="SelectedAyah" Min="1" Max="@MaxAyahNumber" />
        </MudItem>
    </MudGrid>

    <!-- Quran Text Section -->
    <MudDivider Class="my-4" />
    <div style="text-align: right; font-family: 'Amiri', serif; font-size: 20px; line-height: 2;">
        ﷽
        <br />
        اللّهُ لَا إِلَـٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ...
    </div>

    <!-- Translation Section -->
    <MudDivider Class="my-4" />
    <div style="font-size: 14px; line-height: 1.8;">
        Аллоҳ Ундан ўзга илоҳ йўқ зотдир. У тирик ва қоимдир...
    </div>

    <!-- Controls Section -->
    <MudDivider Class="my-4" />
    <MudGrid AlignItems="Center" JustifyContent="Center">
        <MudItem>
            <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" />
        </MudItem>
        <MudItem>
            <MudIconButton Icon="@Icons.Material.Filled.Repeat" Color="Color.Primary" />
        </MudItem>
        <MudItem>
            <MudIconButton Icon="@Icons.Material.Filled.VolumeUp" Color="Color.Primary" />
        </MudItem>
    </MudGrid>

</MudPaper>

@code {
    private int SelectedAyah = 1;        // Default value for Ayah
    private string _state;              // Selected surah name
    private int MaxAyahNumber = 1;      // Maximum Ayah number for the selected surah

    private async Task<IEnumerable<string>> Search(string value, CancellationToken token)
    {
        // API URL
        var apiUrl = "https://api.alquran.cloud/v1/surah";

        // Call API and get the response
        var response = await Http.GetFromJsonAsync<ApiResponse>(apiUrl, token);

        // Return only surah names (Arabic names)
        return response?.Data?.Select(surah => surah.EnglishName) ?? Enumerable.Empty<string>();
    }

    private async Task OnSurahSelected(string surahName)
    {
        _state = surahName;

        // API URL
        var apiUrl = "https://api.alquran.cloud/v1/surah";

        // Fetch surah data to find the max number of Ayahs
        var response = await Http.GetFromJsonAsync<ApiResponse>(apiUrl);
        var selectedSurah = response?.Data?.FirstOrDefault(surah => surah.EnglishName == surahName);

        if (selectedSurah != null)
        {
            MaxAyahNumber = selectedSurah.NumberOfAyahs;
            SelectedAyah = 1; // Reset to 1 for a new surah
        }
    }

    // Classes for deserialization
    public class ApiResponse
    {
        public int Code { get; set; }
        public string Status { get; set; }
        public List<Surah> Data { get; set; }
    }

    public class Surah
    {
        public int Number { get; set; }
        public string Name { get; set; }
        public string EnglishName { get; set; }
        public string EnglishNameTranslation { get; set; }
        public int NumberOfAyahs { get; set; }
        public string RevelationType { get; set; }
    }
}
